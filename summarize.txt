# linux_Maint_Scripts — Summary (linux-maint)

## What this project is

**linux-maint** is a Bash-based maintenance and health-monitoring toolkit for Linux.
It runs a suite of small “monitors” and produces both:

- **Human-readable logs** for troubleshooting
- **Machine-parseable artifacts** (summary line protocol + JSON) for automation, alerting, and reporting

It supports:

- **Repo mode**: run from the git checkout (useful for development/CI)
- **Installed mode**: install to `/usr/local` with stable paths and optional systemd timer/logrotate integration
- **Local-only and fleet orchestration**: CLI/wrapper support targeting multiple hosts over SSH (config-driven)

## High-level architecture

- `run_full_health_monitor.sh` (wrapper)
  - Runs monitor scripts from `monitors/` (installed mode uses copies under `/usr/local/libexec/linux_maint/`).
  - Enforces a **timeout per monitor** (uses `timeout` when available; controlled by `MONITOR_TIMEOUT_SECS`).
  - Enforces the **summary contract**:
    - if a monitor exits non-zero but emits no `monitor=` summary line, wrapper emits:
      - `status=UNKNOWN reason=no_summary_emitted`
  - Computes overall result based on the **worst** monitor exit code.

- `bin/linux-maint` (CLI)
  - Entry point for operators.
  - Handles repo vs installed mode.
  - Provides convenience commands: `run`, `status`, `logs`, `doctor`, `init`, `preflight`, `validate`, `install`, `uninstall`.

- `lib/linux_maint.sh` + `lib/linux_maint_conf.sh`
  - Shared library and configuration loader (including `/etc/linux_maint/linux-maint.conf` and `/etc/linux_maint/conf.d/*`).

## Primary CLI commands (operator-facing)

- `linux-maint run`
  - Executes the wrapper and writes artifacts.
  - Supports fleet flags such as `--group`, `--hosts`, `--exclude`, `--parallel`, `--shuffle`, `--limit`, `--dry-run`.

- `linux-maint status`
  - Shows last run metadata (from `last_status_full`) plus a **compact admin summary** by default:
    - totals by severity (`CRIT/WARN/UNKNOWN/SKIP/OK`)
    - severity-sorted minimal problems list (`STATUS monitor [reason=...]`)
  - Flags:
    - `--verbose` (show raw summary lines)
    - `--problems N` (default 20, max 100)
    - `--only OK|WARN|CRIT|UNKNOWN|SKIP`

- `linux-maint logs [N]` — tail latest wrapper log
- `linux-maint doctor` — diagnostics (paths, timers, permissions)
- `linux-maint init` — create initial config under `/etc/linux_maint`
- `linux-maint preflight` — preflight checks
- `linux-maint validate` — validate configuration
- `linux-maint install|uninstall` — wrapper around `install.sh`

## Exit codes

The project standard is:
- `0` = OK
- `1` = WARN
- `2` = CRIT
- `3` = UNKNOWN/ERROR

Wrapper returns the worst exit code across all executed monitors.

## Output artifacts

Artifacts are intended to be stable and automation-friendly.

Installed mode (default locations):

- Full run log:
  - `/var/log/health/full_health_monitor_<timestamp>.log`
  - symlink: `/var/log/health/full_health_monitor_latest.log`

- Summary log (one line per monitor):
  - `/var/log/health/full_health_monitor_summary_<timestamp>.log`
  - symlink: `/var/log/health/full_health_monitor_summary_latest.log`

- Summary JSON:
  - `/var/log/health/full_health_monitor_summary_<timestamp>.json`
  - symlink: `/var/log/health/full_health_monitor_summary_latest.json`

- Last status file:
  - `/var/log/health/last_status_full` (timestamp/host/overall/exit_code/logfile)

- Optional Prometheus textfile (node_exporter textfile collector):
  - `/var/lib/node_exporter/textfile_collector/linux_maint.prom`

Repo mode writes equivalent artifacts under `./.logs/`.

## Summary contract (line protocol)

Each monitor should emit at least one summary line:

```text
monitor=<name> host=<target> status=<OK|WARN|CRIT|UNKNOWN|SKIP> node=<runner> key=value...
```

Notes:
- Non-OK should ideally include `reason=<token>` (see `docs/REASONS.md`).
- Wrapper emits `SKIP` summary lines for monitors gated by missing optional config/baselines.

## Included monitors (current)

Located in `monitors/`:

- `preflight_check` — environment and prerequisites
- `config_validate` — validate configuration (wrapper treats validation warnings as non-fatal)
- `health_monitor` — general health checks / aggregation
- `inode_monitor` — inode usage
- `disk_trend_monitor` — disk usage trends
- `network_monitor` — basic network checks
- `service_monitor` — service state checks
- `ntp_drift_monitor` — NTP drift thresholds
- `patch_monitor` — pending security updates
- `storage_health_monitor` — storage health (mdraid/smart/nvme)
- `kernel_events_monitor` — kernel log/event scanning
- `cert_monitor` — cert expiry checks (requires `/etc/linux_maint/certs.txt`)
- `nfs_mount_monitor` — NFS mount checks
- `ports_baseline_monitor` — port baseline drift (requires `/etc/linux_maint/ports_baseline.txt`)
- `config_drift_monitor` — config drift (requires `/etc/linux_maint/config_paths.txt`)
- `user_monitor` — baseline user/sudoers drift (requires baseline files)
- `backup_check` — backup checks (targets file driven)
- `inventory_export` — emit inventory snapshot/export

## Configuration

Primary configuration lives under `/etc/linux_maint/`.

Notable config features:
- Main config: `/etc/linux_maint/linux-maint.conf`
- Optional drop-ins: `/etc/linux_maint/conf.d/*.conf`
- Additional lists/baselines under `/etc/linux_maint/` (hosts, excluded, services, ports baseline, certs, users/sudoers baselines, etc.)

Some monitors are gated by optional config/baseline files; wrapper emits `status=SKIP reason=missing:<path>`.

## Packaging / installation

- `install.sh` supports:
  - `--with-user` (optional service user)
  - `--with-timer` (systemd timer)
  - `--with-logrotate`
  - `--uninstall` and optional `--purge`
- RPM packaging exists under `packaging/rpm/` (spec + service/timer files).

## Tooling

- `tools/make_tarball.sh` — create an offline tarball
- `tools/gen_build_info.sh` — build metadata
- `tools/summary_diff.py` — compare/parse summary output (used by installed mode)
- `tools/update_readme_defaults.py` — keep docs defaults in sync

## Documentation

- `README.md` — overview + quickstart
- `docs/QUICK_REFERENCE.md` — operator cheat sheet
- `docs/reference.md` — full reference (monitors, knobs, offline/air-gapped, install)
- `docs/DARK_SITE.md` — offline/air-gapped notes
- `docs/REASONS.md` — reason tokens contract
- `ToDoList.txt` — prioritized actionable backlog
