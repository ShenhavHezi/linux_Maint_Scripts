# linux-maint — ToDoList (Actionable)

This document is a prioritized, actionable backlog to make **linux-maint** safer, more reliable,
and easier to operate at scale.

Conventions:
- **Acceptance** = what “done” means.
- **Where** = likely files/areas to change.
- **Verify** = a quick command/test to prove it works.

---

## P0 — Production safety & correctness (do first)

DONE: Added CI-enforced smoke tests including status output contract and reason= linting.

### P0.1 Enforce exit-code policy across all monitors

**Why**: Wrapper already maps `0/1/2/3` to `OK/WARN/CRIT/UNKNOWN`, but if monitors don’t consistently follow it, overall results and automation are unreliable.

- Policy:
  - `0=OK`, `1=WARN`, `2=CRIT`, `3=UNKNOWN/ERROR`

**Where**:
- `monitors/*.sh` (return codes)
- `run_full_health_monitor.sh` (mapping already exists; keep)
- `docs/reference.md` (ensure policy is documented once)

**Acceptance**:
- Every monitor returns only `0|1|2|3`.
- Any unexpected error path returns `3` with `status=UNKNOWN reason=<token>`.

**Verify**:
- Add a test that runs each monitor in isolation (with `LM_LOCAL_ONLY=true` where applicable) and asserts exit code in set `{0,1,2,3}`.

---

### P0.2 Contract: every monitor must emit at least one summary line

**Why**: Your summary contract is the automation interface. If a monitor fails silently, alerting and dashboards break.

**Where**:
- `monitors/*.sh`
- wrapper hardening already emits `reason=no_summary_emitted`; keep it.

**Acceptance**:
- For each monitor execution (per host), at least one line matches:
  - `^monitor=.* status=(OK|WARN|CRIT|UNKNOWN|SKIP) `
- Non-OK lines include `reason=<token>` (see P2.1).

**Verify**:
- CI test: run wrapper (local-only) and assert:
  - summary log exists
  - each monitor appears at least once in summary log

---

### P0.3 Add CI smoke tests for wrapper artifacts (DONE)

**Where**:
- `tests/` (new test script)
- GitHub Actions workflow (if not already)

**Acceptance**:
- A CI job runs `sudo ./run_full_health_monitor.sh` (or an unprivileged safe mode) and asserts artifacts:
  - `full_health_monitor_latest.log`
  - `full_health_monitor_summary_latest.log`
  - `full_health_monitor_summary_latest.json`
  - `last_status_full`

**Verify**:
- `./tests/<new_smoke_test>.sh`

---

### P0.4 Security hardening for SSH/fleet mode (IN PROGRESS)

**Why**: Fleet mode runs commands on remote systems; defaults must be safe.

**Where**:
- `bin/linux-maint` (host parsing, ssh opts)
- `lib/linux_maint.sh` (SSH execution helpers)
- docs: `README.md` and `docs/reference.md`

**Acceptance**:
- Default SSH opts are non-interactive and time-bounded:
  - `-o BatchMode=yes -o ConnectTimeout=... -o ServerAliveInterval=... -o ServerAliveCountMax=...`
- No use of `eval` on config-sourced data.
- Hostnames and paths are consistently quoted.
- `--dry-run` is guaranteed to perform **no remote execution**.

**Verify**:
- Unit-ish test: `linux-maint run --dry-run ...` produces plan output and does not open SSH connections (mock or grep logs).

---

## P1 — Operability (on-call quality)

### P1.1 `linux-maint status --quiet`

**Why**: On-call wants the shortest possible output.

**Where**:
- `bin/linux-maint` (status command)

**Acceptance**:
- `--quiet` prints only:
  - overall
  - totals
  - problems

**Verify**:
- Snapshot test comparing output format.

---

### P1.2 `linux-maint status --json`

**Why**: Enables easy integration with monitoring systems and scripts.

**Where**:
- `bin/linux-maint` status
- optionally `tools/` for a dedicated formatter

**Acceptance**:
- Emits JSON including:
  - mode, timestamp, overall, exit_code, logfile
  - totals by severity
  - problems array (with monitor, status, reason)

**Verify**:
- `sudo linux-maint status --json | jq .` passes.

---

### P1.3 Log rotation and retention

**Where**:
- installer options (`--with-logrotate`)
- logrotate config templates

**Acceptance**:
- `/var/log/health/*.log` rotated with a sane default retention.
- Does not break latest symlinks.

**Verify**:
- `logrotate -d <config>` shows expected behavior.

---

## P2 — Packaging, deployment, and compatibility

### P2.1 Reason token standardization

**Why**: `reason=` is what makes alerts actionable.

**Where**:
- `docs/REASONS.md`
- all monitors

**Acceptance**:
- All non-OK statuses include `reason=<token>`.
- Tokens are documented in `docs/REASONS.md`.

**Verify**:
- Lint test that scans summary logs and fails when `status!=OK` and missing reason (with exceptions explicitly whitelisted).

---

### P2.2 Packaging hardening (RPM already exists)

**Current**: `packaging/rpm/` includes spec + systemd service/timer.

**Where**:
- `packaging/rpm/*`
- `install.sh`
- `tools/make_tarball.sh` (if used for releases)

**Acceptance**:
- Document release workflow in `docs/reference.md`:
  - build rpm
  - install rpm
  - enable timer
  - uninstall

**Verify**:
- `packaging/rpm/build_rpm.sh` succeeds on a supported build host.

---

### P2.3 Platform/dependency detection

**Why**: missing commands should degrade gracefully and explain why.

**Where**:
- `preflight_check` monitor
- individual monitors (feature detection)

**Acceptance**:
- Missing required dependencies => `UNKNOWN reason=missing_dependency`.
- Missing optional features => `SKIP reason=missing_optional_cmd`.

**Verify**:
- Run in minimal container/VM and observe deterministic reasons.

---

## P3 — Monitor quality & performance

### P3.1 Per-monitor timeout overrides

**Why**: some monitors are fast, others need longer; one global timeout is suboptimal.

**Where**:
- `run_full_health_monitor.sh`
- config (e.g. `/etc/linux_maint/monitor_timeouts.conf`)

**Acceptance**:
- Global default remains.
- Optional per-monitor override supported.

**Verify**:
- Set low timeout for one monitor; confirm it becomes `UNKNOWN reason=timeout`.

---

### P3.2 Reduce summary noise

**Why**: summary should stay actionable.

**Where**:
- monitors (summary line content)

**Acceptance**:
- Summary lines stay short; details go to full log.
- Prefer one summary line per monitor per host.

---

## P4 — Developer experience & project governance

### P4.1 Add Makefile and CONTRIBUTING

**Where**:
- `Makefile`
- `CONTRIBUTING.md`

**Acceptance**:
- `make lint` runs shellcheck
- `make test` runs test suite
- CONTRIBUTING describes monitor contract + how to add a monitor

---

### P4.2 CI enforcement for meta docs

**Why**: keep GitHub landing page accurate.

**Where**:
- GitHub Actions

**Acceptance**:
- CI fails if significant changes happen without touching:
  - `summarize.txt`
  - `ToDoList.txt`

