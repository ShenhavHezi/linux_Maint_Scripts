name: CI

on:
  push:
  pull_request:

jobs:
  shellcheck-and-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: ShellCheck
        run: |
          # Treat known-noisy warnings as suppressed centrally.
          EXCLUDES="SC1090,SC1091,SC2034,SC2016,SC2162,SC2155,SC2317,SC2086"
          shellcheck -x --exclude="$EXCLUDES" run_full_health_monitor.sh
          shellcheck -x --exclude="$EXCLUDES" lib/linux_maint.sh
          shellcheck -x --exclude="$EXCLUDES" bin/linux-maint
          shellcheck -x --exclude="$EXCLUDES" monitors/*.sh
          shellcheck -x --exclude="$EXCLUDES" tests/*.sh
          shellcheck -x --exclude="$EXCLUDES" tools/*.sh

      - name: Summary contract test (unprivileged)
        run: |
          mkdir -p .logs
          ./tests/summary_contract.sh

      - name: Summary contract lint (reason/status/monitor= lines)
        run: |
          ./tests/summary_contract_lint.sh

      - name: Smoke test (best-effort)
        run: |
          chmod +x tests/smoke.sh
          ./tests/smoke.sh || true

  build-rpm-rocky9:
    runs-on: ubuntu-latest
    container:
      image: rockylinux:9
    steps:
      - name: Install build tools
        run: |
          dnf -y update
          dnf -y install rpm-build rsync tar systemd-rpm-macros python3

      - name: Checkout
        uses: actions/checkout@v4

      - name: Build RPM
        run: |
          ./packaging/rpm/build_rpm.sh 0.1.0

      - name: Install RPM (smoke)
        run: |
          dnf -y install /tmp/linux-maint-rpmbuild/RPMS/noarch/*.rpm
          linux-maint --help | head -n 40
          linux-maint version || true
          # systemd checks (may be limited inside container, but unit files should exist)
          test -f /usr/lib/systemd/system/linux-maint.timer
          test -f /usr/lib/systemd/system/linux-maint.service
          systemctl is-enabled linux-maint.timer || true
          systemctl is-active linux-maint.timer || true
          linux-maint doctor || true
          # basic run (best-effort; may fail in container, should not hang)
          timeout 60s /usr/sbin/run_full_health_monitor.sh || true
          test -f /var/log/health/last_status_full || true

      - name: Upload RPM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-maint-rpm-rocky9
          path: /tmp/linux-maint-rpmbuild/RPMS/**/*.rpm
